<!doctype html>
<meta charset="utf-8">

<html>

<head>
	<title>Assignment 3</title>
	<script src="http://d3js.org/d3.v3.min.js"> </script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
</head>

<style>
.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.daily_line {
  fill: none;
  stroke-width: 0.5px;
}

.max {
  stroke: red;
}
.min {
  stroke: blue;
}
.avg {
  stroke: black;
  stroke-width: 1.5px;
}
</style>

<body>
	
	<script>
    // Helpers
    // Shamelessly lifted from https://stackoverflow.com/questions/15313418/javascript-assert
    function assert(condition, message) {
        if (!condition) {
            console.log("Assertion failed: " + (message || "no message"));
            throw "Assertion failed: " + (message || "no message")
        }
    }   
    
    function soft_assert(condition, message) {
        if (!condition) {
            console.log("Check failed: " + (message || "no message"));
        }
    }
    // Shamelessly lifted from https://stackoverflow.com/questions/1408289/best-way-to-do-variable-interpolation-in-javascript
    String.prototype.supplant = function (o) {
        return this.replace(/{([^{}]*)}/g,
            function (a, b) {
                var r = o[b];
                return typeof r === 'string' || typeof r === 'number' ? r : a;
            }
        );
    };
    
    // Acknowledgements
    // Line graph templates shamelessly lifted from http://bl.ocks.org/mbostock/3883245
    
    // Actual code

    var screenHeight = $(window).height(); //reading the screen available height - an absolute value
    var screenWidth = $(window).width(); //reading the screen available width - an absolute value
    var factorWidth = 0.6; //a parameter to set the width for the right graph the daily_timeseries 


	var rezised_body = d3.selectAll("body")
							.style("height", screenWidth); //reading the screen available width -  it returns pixels

    // Data specific variables ("the schema")
    var components = ["Cooling", "Heating", "Lighting", "PlugLoads"]
                            
	//LAYOUT VARIABLES///

    var calcLineGraphWidth = function () {
        return Math.round (screenWidth * factorWidth); //forcing the result to be an integer
    }
    var plot_margin = 30

    // sizes including framing
    var timeseries_total_width = calcLineGraphWidth();
    var timeseries_total_height = screenHeight / 2;
    // raw plot size
    var timeseries_width = timeseries_total_width - plot_margin;
    var timeseries_height = timeseries_total_height - plot_margin;
    
    var barGraphWidth = screenWidth - timeseries_total_width; 

	//SVG Canvas for each graph
	var daily_timeseries_frame_svg = rezised_body.append("svg")
		.attr("width", timeseries_total_width)
		.attr("height", timeseries_total_height)
		.style("float", "left"); // the trick to make them side by side
	var daily_timeseries_svg = daily_timeseries_frame_svg.append("g")
        .attr("transform", "translate(" + plot_margin + ",0)")
        .style("float", "left");
                                
	/*var bar_graph_canvas = rezised_body.append("svg")
		.attr("width", barGraphWidth)
		.attr("height", screenHeight);

	var rect = bar_graph_canvas.append("rect") //NOTE: This is Aux Code - just to test if the canvas for the bar graph is ok
		.attr("width", barGraphWidth)
		.attr("height", screenHeight)
		.attr("fill", "blue")
		.style("float", "left");*/
        
	var hourly_timeseries_frame_svg = rezised_body.append("svg")
		.attr("width", timeseries_total_width)
		.attr("height", timeseries_total_height)
		.style("float", "left"); // the trick to make them side by side
	var hourly_timeseries_svg = hourly_timeseries_frame_svg.append("g")
        .attr("transform", "translate(" + plot_margin + ",0)")
        .style("float", "left");
        
    // Axes
    var daily_x = d3.time.scale()
        .range([0, timeseries_width]);
    var daily_y = d3.scale.linear()
        .range([timeseries_height, 0]);
    var daily_x_axis = d3.svg.axis()
        .scale(daily_x)
        .orient("bottom")
        .tickFormat(d3.format('.0f'));
    var daily_y_axis = d3.svg.axis()
        .scale(daily_y)
        .orient("left")
        .tickFormat(d3.format('.1f'));
    var daily_line_total_min = d3.svg.line()
        .x(function(d) { return daily_x(d.day); })
        .y(function(d) { return daily_y(d.total.min); });
    var daily_line_total_max = d3.svg.line()
        .x(function(d) { return daily_x(d.day); })
        .y(function(d) { return daily_y(d.total.max); });
    var daily_line_total_avg = d3.svg.line()
        .x(function(d) { return daily_x(d.day); })
        .y(function(d) { return daily_y(d.total.avg); });

    var hourly_x = d3.time.scale()
        .range([0, timeseries_width]);
    var hourly_y = d3.scale.linear()
        .range([timeseries_height, 0]);
    var hourly_x_axis = d3.svg.axis()
        .scale(hourly_x)
        .orient("bottom")
        .tickFormat(d3.format('.0f'));
    var hourly_y_axis = d3.svg.axis()
        .scale(hourly_y)
        .orient("left")
        .tickFormat(d3.format('.1f'));
    var hourly_line_total_min = d3.svg.line()
        .x(function(d) { return hourly_x(d.day); })
        .y(function(d) { return hourly_y(d.total.min); });
    var hourly_line_total_max = d3.svg.line()
        .x(function(d) { return hourly_x(d.day); })
        .y(function(d) { return hourly_y(d.total.max); });
    var hourly_line_total_avg = d3.svg.line()
        .x(function(d) { return hourly_x(d.day); })
        .y(function(d) { return hourly_y(d.total.avg); });
    var hourly_line_total = d3.svg.line()
        .x(function(d) { return hourly_x(d.day); })
        .y(function(d) { return hourly_y(d.total); });    
        
    // Load datasets
    // Returns an object of {min: ..., max:..., avg:...} parsed from the row.
    function parse_component_daily(row_record, component_name) {
        var obj =  {
            min: +row_record[component_name + "DailyMinimum"],
            max: +row_record[component_name + "DailyMaximum"],
            avg: +row_record[component_name + "Average "],
        }
        assert(!isNaN(obj.min), "Parse {comp} min failed:".supplant({comp: component_name}) + row_record)
        assert(!isNaN(obj.max), "Parse {comp} max failed:".supplant({comp: component_name}) + row_record)
        assert(!isNaN(obj.avg), "Parse {comp} avg failed:".supplant({comp: component_name}) + row_record)
        return obj
    }
    
    // Called once the daily timeseries CSV has been loaded.
    function on_daily_timeseries_data(data) {
        daily_x.domain(d3.extent(data, function(d) { return d.day; }));
        daily_y.domain([0, d3.max(data, function(d) { return d.total.max; })]);

        daily_timeseries_frame_svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(" + plot_margin + "," + timeseries_height + ")")
            .call(daily_x_axis)
        .append("text")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Day");
            
        daily_timeseries_frame_svg.append("g")
            .attr("class", "y axis")
            .attr("transform", "translate(" + plot_margin + ",0)")
            .call(daily_y_axis)
        .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Energy");
            
        daily_timeseries_svg.append("path")
            .datum(data)
            .attr("class", "daily_line min")
            .attr("d", daily_line_total_min)
            .attr("opacity", 0)
            .transition()
            .attr("opacity", 1)
        daily_timeseries_svg.append("path")
            .datum(data)
            .attr("class", "daily_line max")
            .attr("d", daily_line_total_max)
            .attr("opacity", 0)
            .transition()
            .attr("opacity", 1)
        daily_timeseries_svg.append("path")
            .datum(data)
            .attr("class", "daily_line avg")
            .attr("d", daily_line_total_avg)
            .attr("opacity", 0)
            .transition()
            .attr("opacity", 1)
    }
    
    function on_daily_data(error, rows) {
        console.log(rows)
        on_daily_timeseries_data(rows);
        
        // TODO: piechart / barchart aggregation and rendering

    }
    
    function on_hourly_timeseries_data(data) {
        hourly_x.domain(d3.extent(data, function(d) { return d.day; }));
        hourly_y.domain([0, d3.max(data, function(d) { return d.total; })]);

        hourly_timeseries_frame_svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(" + plot_margin + "," + timeseries_height + ")")
            .call(hourly_x_axis)
        .append("text")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Day");
            
        hourly_timeseries_frame_svg.append("g")
            .attr("class", "y axis")
            .attr("transform", "translate(" + plot_margin + ",0)")
            .call(hourly_y_axis)
        .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Energy");
            
        hourly_timeseries_svg.append("path")
            .datum(data)
            .attr("class", "daily_line min")
            .attr("d", hourly_line_total)
            .attr("opacity", 0)
            .transition()
            .attr("opacity", 1)
    }
    function on_hourly_data(error, rows) {
        console.log(rows)
        on_hourly_timeseries_data(rows);
        
        // TODO: piechart / barchart aggregation and rendering

    }
    
    d3.dsv(";", "text/plain")("data_set.csv")
        .row(function(d) { 
            var obj = {"day": +d.Day, "total":{min:0.0, max:0.0, avg:0.0}}
            assert(!isNaN(obj.day), "Parse day failed: " + d)
            components.forEach(function (component) {
                var comp_obj = parse_component_daily(d, component)
                obj.total.min += comp_obj.min
                obj.total.max += comp_obj.max
                obj.total.avg += comp_obj.avg
                obj[component] = comp_obj

                soft_assert(comp_obj.min <= comp_obj.avg, "day {day} {comp} min {min} > avg {avg}".supplant({day: obj.day, comp: component, min:comp_obj.min, avg: comp_obj.avg}))
                soft_assert(comp_obj.avg <= comp_obj.max, "day {day} {comp} avg {avg} > max {max}".supplant({day: obj.day, comp: component, avg:comp_obj.avg, max: comp_obj.max}))
            })
            
            return obj
        }).get(on_daily_data);
             
    d3.dsv(";", "text/plain")("data_set_hourly.csv")
        .row(function(d) { 
            var obj = {"day": +d.Day + d.Hour/24.0, "total":0.0}
            assert(!isNaN(obj.day), "Parse day failed: " + d)
            components.forEach(function (component) {
                obj[component] = +d[component + "Hourly"]
                obj.total += obj[component]
                assert(!isNaN(obj[component]), "Failed to parse hourly " + component)
            })
            return obj
        }).get(on_hourly_data);
             
	</script>

</body>

</html>